Chef John's Coq Au Vin
6 bone-in, skin-on chicken thighs1 pinch kosher salt and freshly ground black pepper to taste8 ounces bacon, sliced crosswise into 1/2-inch pieces10 large button mushrooms, quartered½ large yellow onion, diced2 shallots, sliced2 teaspoons all-purpose flour2 teaspoons butter1 ½ cups red wine6 sprigs fresh thyme1 cup chicken broth